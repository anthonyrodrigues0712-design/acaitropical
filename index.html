<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel de Vendas - Açaí Tropical (IndexedDB + Login)</title>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <link rel="stylesheet" href="styles.css" />

  <!-- Firebase (módulo) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      addDoc,
      setDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    window.firebaseConfig = {
  apiKey: "AIzaSyAOC1m6oYNLxiRUbP5VqhTPVadNYqOvqMg",
  authDomain: "acai-projeto.firebaseapp.com",
  projectId: "acai-projeto",
  storageBucket: "acai-projeto.firebasestorage.app",
  messagingSenderId: "606846834152",
  appId: "1:606846834152:web:6d7e2b4457ab56bb15405d",
  measurementId: "G-9DQPBBNMDB"
};

    const app = initializeApp(window.firebaseConfig);
    window.dbOnline = getFirestore(app);

    window._fb_collection = collection;
    window._fb_getDocs = getDocs;
    window._fb_setDoc = setDoc;
    window._fb_doc = doc;
    window._fb_addDoc = addDoc;
  </script>
</head>

<body>
  <!-- seu HTML permanece igual -->

  <header class="header">
    <div class="header-inner" style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <div>
        <h1>Painel de Vendas - Açaí Tropical</h1>
        <p class="subtitle">Acompanhe as vendas de maneira efici</p>
      </div>

      <div style="text-align:right;">
        <div style="font-size:13px; color:var(--muted);">Vendedor logado:</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <strong id="vendedorNome" style="color:var(--primary);">—</strong>
          <button id="logoutBtn" class="small-btn" style="padding:6px 10px; border-radius:8px;">Sair</button>
        </div>
      </div>
    </div>
    <hr />
  </header>

  <main class="main">
    <section class="top-cards" aria-label="Métricas principais">
      <div class="card metric-card">
        <h4>PEDIDOS DO DIA</h4>
        <div class="metric-value" id="ordersToday">0</div>
        <p class="subtext" id="ordersDelta">—</p>
      </div>

      <div class="card metric-card">
        <h4>VALOR EM VENDAS</h4>
        <div class="metric-value" id="revenueToday">R$ 0,00</div>
        <p class="subtext" id="revenueDelta">—</p>
      </div>

      <div class="card metric-card">
        <h4>VENDEDOR</h4>
        <div class="metric-value" id="vendorNameCard">—</div>
        <p class="subtext" id="vendorSubtext">Logado</p>
      </div>
    </section>

    <div class="actions-row">
      <button id="openSaleLayer" class="primary-btn">Registrar Venda</button>
      <button id="generateReportBtn" class="ghost-btn">Gerar relatório (salvar + baixar PDF)</button>
    </div>

    <section class="content">
      <aside class="panel left-panel">
        <h3>Ações importantes</h3>

        <div class="meta">
          <h4>Meta do dia</h4>
          <div class="meta-info">
            <div class="meta-value" id="metaPercent">0%</div>
            <div class="meta-target">Meta R$ <span id="metaTargetValue">500,00</span></div>
          </div>

          <div class="meta-setter">
            <input id="metaInput" type="number" min="0" step="1" />
            <button id="saveMetaBtn" class="small-btn">Salvar meta</button>
          </div>

          <div class="progress-wrap" aria-hidden="true">
            <div class="progress-bar" id="progressBar" style="width:0%"></div>
          </div>
          <p class="note" id="metaNote">Colete mais vendas para atingir a meta.</p>
        </div>

        <div class="payment-totals">
          <h4>Totais por forma</h4>
          <div class="payment-line">Dinheiro: <strong id="totalDinheiro">R$ 0,00</strong></div>
          <div class="payment-line">PIX: <strong id="totalPIX">R$ 0,00</strong></div>
          <div class="payment-line">Cartão: <strong id="totalCartao">R$ 0,00</strong></div>
        </div>

        <div class="reports-panel">
          <h4>Relatórios</h4>
          <div id="reportsList" class="reports-list"></div>
        </div>
      </aside>

      <section class="panel right-panel">
        <div class="panel-header">
          <div>
            <h3>Vendas recentes</h3>
            <small class="muted">Mostrando até 5 últimas vendas</small>
          </div>

          <div class="filter-row">
            <label for="paymentFilter" class="muted">Filtrar por forma:</label>
            <select id="paymentFilter">
              <option value="all">Todas</option>
              <option value="Dinheiro">Dinheiro</option>
              <option value="PIX">PIX</option>
              <option value="Cartão">Cartão</option>
            </select>
          </div>
        </div>

        <div id="recentSales" class="sales-list"></div>

        <div class="panel-footer">
          <button id="clearSalesBtn" class="danger-btn">Limpar histórico</button>
        </div>
      </section>
    </section>
  </main>

  <!-- Modal / Sale -->
  <div id="saleLayer" class="sale-layer" aria-hidden="true">
    <div class="sale-content" role="dialog" aria-modal="true" aria-labelledby="saleTitle">
      <h2 id="saleTitle">Registrar Venda</h2>

      <label for="product">Produto</label>
      <select id="product">
        <option value="acai">Açaí</option>
        <option value="agua">Água</option>
        <option value="refri">Refrigerante</option>
      </select>

      <label for="quantity">Quantidade</label>
      <input id="quantity" type="number" min="1" value="1" />

      <label for="unitPriceInput">Preço unitário (R$)</label>
      <input id="unitPriceInput" type="number" step="0.01" min="0" placeholder="Informe o preço unitário" />

      <div class="row">
        <div class="price-preview">
          <small>Total</small>
          <div id="totalPrice">R$ 0,00</div>
        </div>

        <div style="width:48%">
          <label for="paymentMethod">Forma de pagamento</label>
          <select id="paymentMethod">
            <option value="Dinheiro">Dinheiro</option>
            <option value="PIX">PIX</option>
            <option value="Cartão">Cartão</option>
          </select>
        </div>
      </div>

      <div class="modal-actions">
        <button id="confirmSaleBtn" class="primary-btn">Confirmar Venda</button>
        <button id="closeSaleLayer" class="ghost-btn">Fechar</button>
      </div>
      <div id="saleMsg" class="message" aria-live="polite"></div>
    </div>
  </div>

  <!-- Modal / Login -->
  <div id="loginLayer" class="sale-layer" aria-hidden="true">
    <div class="sale-content" role="dialog" aria-modal="true" aria-labelledby="loginTitle" style="max-width:380px;">
      <h2 id="loginTitle">Entrar</h2>

      <label for="loginUser">Usuário</label>
      <input id="loginUser" type="text" placeholder="usuário" />

      <label for="loginPass">Senha</label>
      <input id="loginPass" type="password" placeholder="senha" />

      <div style="display:flex; gap:8px; align-items:center;">
        <button id="loginBtn" class="primary-btn">Entrar</button>
        <button id="createUserBtn" class="small-btn">Criar usuário</button>
      </div>

      <p id="loginError" style="color:#c0392b; display:none; margin-top:8px;">Usuário ou senha inválidos.</p>
      <p style="font-size:12px; color:var(--muted); margin-top:8px;">Se não há usuários, clique em "Criar usuário" para
        gerar um usuário demo.</p>
    </div>
  </div>

  <script>
    (function () {
      /* -----------------------------
         IndexedDB helper (promises)
         ----------------------------- */
      const DB_NAME = 'acaiDB';
      const DB_VERSION = 1;
      const STORE_SALES = 'sales';
      const STORE_REPORTS = 'reports';
      const STORE_META = 'meta';

      function openDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, DB_VERSION);
          req.onupgradeneeded = (ev) => {
            const db = ev.target.result;
            if (!db.objectStoreNames.contains(STORE_SALES)) {
              db.createObjectStore(STORE_SALES, { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains(STORE_REPORTS)) {
              db.createObjectStore(STORE_REPORTS, { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains(STORE_META)) {
              db.createObjectStore(STORE_META, { keyPath: 'key' });
            }
          };
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      }

      async function dbGetAll(storeName) {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readonly');
          const store = tx.objectStore(storeName);
          const req = store.getAll();
          req.onsuccess = () => resolve(req.result || []);
          req.onerror = () => reject(req.error);
        });
      }

      async function dbAdd(storeName, obj) {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readwrite');
          const store = tx.objectStore(storeName);
          const req = store.add(obj);
          req.onsuccess = () => resolve(req.result);
          req.onerror = (e) => reject(e.target.error);
        });
      }

      async function dbPut(storeName, obj) {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readwrite');
          const store = tx.objectStore(storeName);
          const req = store.put(obj);
          req.onsuccess = () => resolve(req.result);
          req.onerror = (e) => reject(e.target.error);
        });
      }

      async function dbClear(storeName) {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readwrite');
          const store = tx.objectStore(storeName);
          const req = store.clear();
          req.onsuccess = () => resolve();
          req.onerror = () => reject(req.error);
        });
      }

      async function dbGet(storeName, key) {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readonly');
          const store = tx.objectStore(storeName);
          const req = store.get(key);
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      }

      // keys locais
      const USERS_KEY = "users_acai";
      const LOGGED_KEY = "logged_user_acai";

      /* -----------------------------
         Firestore helper (usa funções exportadas pelo módulo)
         ----------------------------- */
      async function getUsersOnline() {
        try {
          const snap = await window._fb_getDocs(window._fb_collection(window.dbOnline, "users"));
          const users = [];
          snap.forEach(d => users.push(d.data()));
          return users;
        } catch (err) {
          console.warn('Não foi possível buscar usuários online:', err);
          return []; // retornar array vazio ao falhar
        }
      }

      async function createUserOnline(username, password, name) {
        try {
          await window._fb_setDoc(window._fb_doc(window.dbOnline, "users", username), {
            username,
            password,
            name
          });
          return true;
        } catch (err) {
          console.error('Erro criando usuário online:', err);
          throw err;
        }
      }

      async function loginOnline(username, password) {
        try {
          const snap = await window._fb_getDocs(window._fb_collection(window.dbOnline, "users"));
          let found = null;
          snap.forEach(d => {
            const u = d.data();
            if (u.username === username && u.password === password) {
              found = u;
            }
          });
          return found;
        } catch (err) {
          console.warn('Falha ao consultar usuários online:', err);
          return null;
        }
      }

      // vendas online
      async function fetchSalesOnline() {
        try {
          const snap = await window._fb_getDocs(window._fb_collection(window.dbOnline, "sales"));
          const arr = [];
          snap.forEach(d => {
            const data = d.data();
            arr.push(data);
          });
          return arr;
        } catch (err) {
          console.warn('Falha ao buscar vendas online:', err);
          return [];
        }
      }

      async function pushSaleOnline(sale) {
        try {
          // usa setDoc com id customizado (sale.id) para manter id consistente
          await window._fb_setDoc(window._fb_doc(window.dbOnline, "sales", sale.id), sale);
          return true;
        } catch (err) {
          console.warn('Falha ao enviar venda para Firestore:', err);
          return false;
        }
      }

      async function fetchReportsOnline() {
        try {
          const snap = await window._fb_getDocs(window._fb_collection(window.dbOnline, "reports"));
          const arr = [];
          snap.forEach(d => arr.push(d.data()));
          return arr;
        } catch (err) {
          console.warn('Falha ao buscar reports online:', err);
          return [];
        }
      }

      async function pushReportOnline(report) {
        try {
          await window._fb_setDoc(window._fb_doc(window.dbOnline, "reports", report.id), report);
          return true;
        } catch (err) {
          console.warn('Falha ao enviar report para Firestore:', err);
          return false;
        }
      }

      /* -----------------------------
         Local storage helpers (mantidos para sessão local)
         ----------------------------- */
      function getUsers() {
        try {
          return JSON.parse(localStorage.getItem(USERS_KEY)) || [];
        } catch {
          return [];
        }
      }

      function saveUsers(users) {
        localStorage.setItem(USERS_KEY, JSON.stringify(users));
      }

      function getLoggedUser() {
        try {
          return JSON.parse(localStorage.getItem(LOGGED_KEY));
        } catch {
          return null;
        }
      }

      function setLoggedUser(user) {
        localStorage.setItem(LOGGED_KEY, JSON.stringify(user));
      }

      function clearLoggedUser() {
        localStorage.removeItem(LOGGED_KEY);
      }

      /* -----------------------------
         Seeding / compatibilidade
         ----------------------------- */
      function seedUsersIfNeeded() {
        try {
          const raw = localStorage.getItem(USERS_KEY);
          if (!raw) {
            localStorage.setItem(USERS_KEY, JSON.stringify([]));
          }
        } catch (err) {
          console.warn('seedUsersIfNeeded falhou:', err);
        }
      }

      /* -----------------------------
         Sync logic: baixar do online e salvar no IndexedDB
         ----------------------------- */
      async function syncFromOnline() {
        try {
          // buscar vendas e reports do firestore
          const onlineSales = await fetchSalesOnline();
          const onlineReports = await fetchReportsOnline();

          // gravar cada venda/report no IndexedDB (put para substituir/atualizar)
          for (const s of onlineSales) {
            try {
              await dbPut(STORE_SALES, s);
            } catch (e) { console.warn('dbPut sale falhou:', e); }
          }
          for (const r of onlineReports) {
            try {
              await dbPut(STORE_REPORTS, r);
            } catch (e) { console.warn('dbPut report falhou:', e); }
          }

          // recarregar estado local
          await loadStateFromDB();
          updateUI();
          console.log('Sincronização online -> local concluída (', onlineSales.length, 'vendas )');
        } catch (err) {
          console.warn('syncFromOnline falhou:', err);
        }
      }

      /* -----------------------------
         Small migration from localStorage (if exists)
         ----------------------------- */
      async function migrateLocalStorageIfNeeded() {
        try {
          const s = localStorage.getItem('acai_sales_v1');
          const r = localStorage.getItem('acai_reports_v1');
          const m = localStorage.getItem('acai_meta_v1');

          const existingSales = await dbGetAll(STORE_SALES);
          if (existingSales.length === 0 && s) {
            const sales = JSON.parse(s);
            for (const sale of sales) {
              if (!sale.id) sale.id = 'S' + Date.now() + Math.random();
              await dbPut(STORE_SALES, sale);
            }
          }
          const existingReports = await dbGetAll(STORE_REPORTS);
          if (existingReports.length === 0 && r) {
            const reports = JSON.parse(r);
            for (const rep of reports) {
              if (!rep.id) rep.id = 'R' + Date.now() + Math.random();
              await dbPut(STORE_REPORTS, rep);
            }
          }
          if (m) {
            const parsed = parseFloat(m);
            if (!isNaN(parsed)) {
              await dbPut(STORE_META, { key: 'dailyGoal', value: parsed });
            }
          }
        } catch (err) {
          console.warn('Migração localStorage falhou (não crítica):', err);
        }
      }

      /* -----------------------------
         App logic (uses IndexedDB)
         ----------------------------- */
      const PRICE_SUGGEST = { agua: 3.00, refri: 5.00 };

      let sales = [];
      let reports = [];
      let dailyGoal = 500.00;
      let currentUser = null;

      // DOM refs
      const openSaleLayerBtn = document.getElementById('openSaleLayer');
      const saleLayer = document.getElementById('saleLayer');
      const closeSaleLayerBtn = document.getElementById('closeSaleLayer');
      const productSelect = document.getElementById('product');
      const quantityInput = document.getElementById('quantity');
      const unitPriceInput = document.getElementById('unitPriceInput');
      const totalPriceEl = document.getElementById('totalPrice');
      const paymentMethodSelect = document.getElementById('paymentMethod');
      const confirmSaleBtn = document.getElementById('confirmSaleBtn');
      const recentSalesEl = document.getElementById('recentSales');
      const ordersTodayEl = document.getElementById('ordersToday');
      const revenueTodayEl = document.getElementById('revenueToday');
      const vendorNameCardEl = document.getElementById('vendorNameCard');
      const progressBar = document.getElementById('progressBar');
      const metaPercent = document.getElementById('metaPercent');
      const metaTargetValue = document.getElementById('metaTargetValue');
      const metaNote = document.getElementById('metaNote');
      const reportsListEl = document.getElementById('reportsList');
      const generateReportBtn = document.getElementById('generateReportBtn');
      const clearSalesBtn = document.getElementById('clearSalesBtn');
      const saleMsg = document.getElementById('saleMsg');
      const metaInput = document.getElementById('metaInput');
      const saveMetaBtn = document.getElementById('saveMetaBtn');
      const paymentFilter = document.getElementById('paymentFilter');
      const totalDinheiroEl = document.getElementById('totalDinheiro');
      const totalPIXEl = document.getElementById('totalPIX');
      const totalCartaoEl = document.getElementById('totalCartao');
      const vendedorNomeEl = document.getElementById('vendedorNome');
      const logoutBtn = document.getElementById('logoutBtn');

      // login dom
      const loginLayer = document.getElementById('loginLayer');
      const loginUserInput = document.getElementById('loginUser');
      const loginPassInput = document.getElementById('loginPass');
      const loginBtn = document.getElementById('loginBtn');
      const loginError = document.getElementById('loginError');
      const createUserBtn = document.getElementById('createUserBtn');

      const money = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
      const formatDateTime = ts => new Date(ts).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });

      /* Init */
      async function init() {
        try {
          seedUsersIfNeeded(); // garante que a função exista e não quebre init
          await openDB();
          await migrateLocalStorageIfNeeded();
          await loadStateFromDB();
          bindEvents();
          restoreLogin();
          // sincroniza do online para local (se Firestore configurado)
          await syncFromOnline();
          updateUI();
        } catch (err) {
          console.error('Erro inicializando app:', err);
          alert('Erro ao inicializar o banco local. Veja o console.');
        }
      }

      async function loadStateFromDB() {
        sales = await dbGetAll(STORE_SALES);
        reports = await dbGetAll(STORE_REPORTS);
        const meta = await dbGet(STORE_META, 'dailyGoal');
        if (meta && typeof meta.value === 'number') dailyGoal = meta.value;
      }

      function bindEvents() {
        openSaleLayerBtn.addEventListener('click', () => {
          if (!currentUser) { showLoginLayer(true); return; }
          showSaleLayer(true);
        });
        closeSaleLayerBtn.addEventListener('click', () => showSaleLayer(false));
        saleLayer.addEventListener('click', (e) => { if (e.target === saleLayer) showSaleLayer(false); });

        productSelect.addEventListener('change', onProductChange);
        quantityInput.addEventListener('input', updateTotalFromInputs);
        unitPriceInput.addEventListener('input', updateTotalFromInputs);

        confirmSaleBtn.addEventListener('click', handleConfirmSale);
        generateReportBtn.addEventListener('click', () => {
          if (!currentUser) { showLoginLayer(true); return; }
          handleGenerateReport();
        });

        clearSalesBtn.addEventListener('click', async () => {
          if (!confirm('Limpar todo o histórico de vendas? Esta ação não pode ser desfeita.')) return;
          await dbClear(STORE_SALES);
          await dbClear(STORE_REPORTS);
          sales = [];
          reports = [];
          updateUI();
        });

        saveMetaBtn.addEventListener('click', async () => {
          const val = parseFloat(metaInput.value);
          if (isNaN(val) || val < 0) { alert('Insira um valor válido para a meta.'); return; }
          dailyGoal = +val.toFixed(2);
          await dbPut(STORE_META, { key: 'dailyGoal', value: dailyGoal });
          updateUI();
          alert('Meta atualizada: ' + money(dailyGoal));
        });

        paymentFilter.addEventListener('change', () => renderRecentSales());

        // login events
        loginBtn.addEventListener('click', doLogin);
        loginUserInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') doLogin(); });
        loginPassInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') doLogin(); });
        createUserBtn.addEventListener('click', createDemoUser);

        logoutBtn.addEventListener('click', () => {
          clearLoggedUser();
          currentUser = null;
          vendedorNomeEl.textContent = '—';
          showLoginLayer(true);
        });
      }

      function restoreLogin() {
        const u = getLoggedUser();
        if (u && u.username) {
          // se há usuário salvo localmente, tenta restaurar a sessão (sem validação extra)
          currentUser = u;
          vendedorNomeEl.textContent = currentUser.name || currentUser.username;
          showLoginLayer(false);
        } else {
          // força pedir login
          showLoginLayer(true);
        }
      }

      function showLoginLayer(show = true) {
        loginLayer.style.display = show ? 'flex' : 'none';
        loginLayer.setAttribute('aria-hidden', show ? 'false' : 'true');
        if (show) {
          loginUserInput.value = '';
          loginPassInput.value = '';
          loginError.style.display = 'none';
          loginUserInput.focus();
        }
      }

      function showSaleLayer(show = true) {
        saleLayer.style.display = show ? 'flex' : 'none';
        saleLayer.setAttribute('aria-hidden', show ? 'false' : 'true');
        saleMsg.textContent = '';
        if (show) {
          productSelect.value = 'acai';
          quantityInput.value = 1;
          unitPriceInput.value = '';
          paymentMethodSelect.value = 'Dinheiro';
          onProductChange();
          unitPriceInput.focus();
        }
      }

      async function createDemoUser() {
        const username = loginUserInput.value.trim() || "vendedor" + Math.floor(Math.random() * 999);
        const password = loginPassInput.value.trim() || "1234";

        // tentar criar usuário online (se possível)
        try {
          const users = await getUsersOnline();
          if (users.some(u => u.username === username)) {
            loginError.textContent = "Usuário já existe";
            loginError.style.display = "block";
            return;
          }

          await createUserOnline(username, password, username);

          alert(`Usuário criado: ${username} (senha: ${password})`);
        } catch (err) {
          alert('Erro ao criar usuário online. Verifique o console.');
          console.error(err);
        }
      }

      async function doLogin() {
        const user = loginUserInput.value.trim();
        const pass = loginPassInput.value.trim();

        // tenta login online (se Firestore disponível)
        const found = await loginOnline(user, pass);

        if (!found) {
          loginError.style.display = 'block';
          return;
        }

        currentUser = found;
        setLoggedUser(found); // ainda salva local, mas só para manter sessão
        vendedorNomeEl.textContent = currentUser.name || currentUser.username;
        showLoginLayer(false);

        // após login, sincroniza com o Firestore (garante que vê as vendas mais recentes)
        await syncFromOnline();
        updateUI();
      }

      function onProductChange() {
        const prod = productSelect.value;
        if (PRICE_SUGGEST.hasOwnProperty(prod)) {
          unitPriceInput.value = PRICE_SUGGEST[prod].toFixed(2);
        } else {
          unitPriceInput.value = '';
        }
        updateTotalFromInputs();
      }

      function updateTotalFromInputs() {
        const qty = Math.max(1, parseInt(quantityInput.value) || 1);
        const unit = Math.max(0, parseFloat(unitPriceInput.value) || 0);
        const total = +(unit * qty).toFixed(2);
        totalPriceEl.textContent = money(total);
      }

      async function handleConfirmSale() {
        if (!currentUser) { showLoginLayer(true); return; }

        const prod = productSelect.value;
        const qty = Math.max(1, parseInt(quantityInput.value) || 1);
        const unit = Math.max(0, parseFloat(unitPriceInput.value) || 0);
        const total = +(unit * qty).toFixed(2);
        const paymentMethod = paymentMethodSelect.value || 'Dinheiro';
        const ts = Date.now();
        const id = 'S' + ts;

        if (unit <= 0) {
          if (!confirm('Preço unitário é zero. Deseja registrar a venda mesmo assim?')) return;
        }

        const sale = {
          id,
          product: prod,
          qty,
          unit,
          total,
          paymentMethod,
          ts,
          seller: currentUser.username,
          sellerName: currentUser.name || currentUser.username
        };

        // primeiro salva local
        try {
          await dbAdd(STORE_SALES, sale);
        } catch (err) {
          // se já existir, faz put
          try { await dbPut(STORE_SALES, sale); } catch (e) { console.warn('dbPut falhou:', e); }
        }

        // tenta enviar para Firestore; se falhar continuará no local e será sincronizado depois
        const ok = await pushSaleOnline(sale);
        if (!ok) console.warn('Venda gravada localmente, sem conexão para enviar ao Firestore.');

        sales.unshift(sale);
        saleMsg.textContent = `Venda registrada: ${productLabel(prod)} — ${qty} x ${money(unit)} = ${money(total)} (${paymentMethod})`;
        setTimeout(() => saleMsg.textContent = '', 3000);
        updateUI();
        showSaleLayer(false);
      }

      function productLabel(key) {
        if (key === 'acai') return 'Açaí';
        if (key === 'agua') return 'Água';
        if (key === 'refri') return 'Refrigerante';
        return key;
      }

      async function handleGenerateReport() {
        if (!currentUser) { showLoginLayer(true); return; }
        if (sales.length === 0) { alert('Não há vendas registradas para gerar relatório.'); return; }

        const totalValue = sales.reduce((s, v) => s + v.total, 0);
        const itemsCount = sales.reduce((s, v) => s + v.qty, 0);
        const report = {
          id: 'R' + Date.now(),
          ts: Date.now(),
          totalValue: +totalValue.toFixed(2),
          itemsCount,
          salesCount: sales.length,
          items: [...sales]
        };

        try {
          await dbAdd(STORE_REPORTS, report);
        } catch (err) {
          await dbPut(STORE_REPORTS, report);
        }

        // push para firestore (não crítico)
        const ok = await pushReportOnline(report);
        if (!ok) console.warn('Report gravado localmente, sem conexão para enviar ao Firestore.');

        reports.unshift(report);
        updateUI();
        downloadReportAsPDF(report);
      }

      function downloadReportAsPDF(report) {
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({ unit: 'pt', format: 'a4' });
          const margin = 40;
          let y = 40;
          const lineHeight = 13;
          const pageHeight = doc.internal.pageSize.getHeight();

          doc.setFontSize(16);
          doc.setTextColor('#6a1b9a');
          doc.text('Relatório de Vendas - Açaí Tropical', margin, y); y += 20;

          doc.setFontSize(10); doc.setTextColor('#333');
          doc.text(`Gerado em: ${formatDateTime(report.ts)}`, margin, y); y += 16;
          doc.text(`Vendas: ${report.salesCount} — Itens: ${report.itemsCount}`, margin, y); y += 16;

          doc.setDrawColor(220); doc.setLineWidth(0.5);
          doc.line(margin, y, doc.internal.pageSize.getWidth() - margin, y); y += 12;

          const pageWidth = doc.internal.pageSize.getWidth();
          // column widths
          const cw = {
            produto: 140,
            qtd: 36,
            unit: 60,
            total: 60,
            forma: 70,
            vendedor: 90
          };
          const startX = margin;
          const col = {
            produto: startX,
            qtd: startX + cw.produto,
            unit: startX + cw.produto + cw.qtd,
            total: startX + cw.produto + cw.qtd + cw.unit,
            forma: startX + cw.produto + cw.qtd + cw.unit + cw.total,
            vendedor: startX + cw.produto + cw.qtd + cw.unit + cw.total + cw.forma,
            hora: pageWidth - margin
          };

          doc.setFontSize(10); doc.setFont(undefined, 'bold');
          doc.text('Produto', col.produto, y);
          doc.text('Qtd', col.qtd + cw.qtd / 2, y, { align: 'center' });
          doc.text('Unitário', col.unit + cw.unit - 2, y, { align: 'right' });
          doc.text('Total', col.total + cw.total - 2, y, { align: 'right' });
          doc.text('Forma', col.forma + 4, y);
          doc.text('Vendedor', col.vendedor + 4, y);
          doc.text('Hora', col.hora, y, { align: 'right' });
          doc.setFont(undefined, 'normal');
          y += lineHeight;

          for (let i = 0; i < report.items.length; i++) {
            const s = report.items[i];
            if (y + 30 > pageHeight - margin) { doc.addPage(); y = margin; }
            doc.setFontSize(10);
            doc.text(productLabel(s.product), col.produto, y);
            doc.text(String(s.qty), col.qtd + cw.qtd / 2, y, { align: 'center' });
            doc.text(money(s.unit), col.unit + cw.unit - 2, y, { align: 'right' });
            doc.text(money(s.total), col.total + cw.total - 2, y, { align: 'right' });
            doc.text(String(s.paymentMethod), col.forma + 4, y);
            doc.text(String(s.sellerName || s.seller || '--'), col.vendedor + 4, y);
            doc.text(formatDateTime(s.ts), col.hora, y, { align: 'right' });
            y += lineHeight;
          }

          if (y + 40 > pageHeight - margin) { doc.addPage(); y = margin; }
          y += 8;
          doc.line(margin, y, pageWidth - margin, y); y += 14;
          doc.setFont(undefined, 'bold');
          doc.text('TOTAL:', margin, y);
          doc.text(money(report.totalValue), pageWidth - margin, y, { align: 'right' });

          const filename = `relatorio_${report.id}.pdf`;
          doc.save(filename);
        } catch (err) {
          console.error('Erro ao gerar PDF:', err);
          alert('Erro ao gerar PDF. Veja o console.');
        }
      }

      /* Rendering */
      function updateUI() {
        metaTargetValue.textContent = dailyGoal.toFixed(2).replace('.', ',');
        metaInput.value = dailyGoal;
        renderTopCards();
        renderRecentSales();
        renderReports();
        updateMetaProgress();
        renderPaymentTotals();
        // update header vendedor
        vendedorNomeEl.textContent = currentUser ? (currentUser.name || currentUser.username) : '—';
      }

      function isSameDay(tsA, tsB) {
        const a = new Date(tsA), b = new Date(tsB);
        return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
      }

      function renderTopCards() {
        const today = Date.now();
        const todaysSales = sales.filter(s => isSameDay(s.ts, today));
        const ordersToday = todaysSales.length;
        const revenueToday = todaysSales.reduce((sum, s) => sum + s.total, 0);
        ordersTodayEl.textContent = ordersToday;
        revenueTodayEl.textContent = money(revenueToday);
        // agora mostra o nome do vendedor logado no card
        vendorNameCardEl.textContent = currentUser ? (currentUser.name || currentUser.username) : '—';
        document.getElementById('ordersDelta').textContent = `Meta diária: ${money(dailyGoal)}`;
      }

      function renderRecentSales() {
        const filter = paymentFilter.value || 'all';
        let filtered = [...sales];
        if (filter !== 'all') filtered = filtered.filter(s => s.paymentMethod === filter);
        const last = filtered.sort((a, b) => b.ts - a.ts).slice(0, 5);
        recentSalesEl.innerHTML = '';
        if (last.length === 0) { recentSalesEl.innerHTML = '<p class="muted">Nenhuma venda registrada.</p>'; return; }
        last.forEach(s => {
          const el = document.createElement('div');
          el.className = 'sale-item';
          el.innerHTML = `
          <div class="sale-left">
            <div class="sale-title">${productLabel(s.product)}</div>
            <div class="sale-meta">Pedido ${s.id} — ${s.qty} x ${money(s.unit)} — ${s.paymentMethod} — ${s.sellerName || s.seller || '—'}</div>
          </div>
          <div class="sale-right">
            <div class="sale-total">${money(s.total)}</div>
            <div class="sale-time">${formatDateTime(s.ts)}</div>
          </div>
        `;
          recentSalesEl.appendChild(el);
        });
      }

      function renderPaymentTotals() {
        const totals = { Dinheiro: 0, PIX: 0, Cartão: 0 };
        sales.forEach(s => { if (totals.hasOwnProperty(s.paymentMethod)) totals[s.paymentMethod] += s.total; });
        totalDinheiroEl.textContent = money(totals.Dinheiro);
        totalPIXEl.textContent = money(totals.PIX);
        totalCartaoEl.textContent = money(totals.Cartão);
      }

      function renderReports() {
        reportsListEl.innerHTML = '';
        if (!reports || reports.length === 0) { reportsListEl.innerHTML = '<p class="muted">Nenhum relatório gerado.</p>'; return; }
        reports.forEach(r => {
          const item = document.createElement('div');
          item.className = 'report-item';
          item.innerHTML = `
          <div class="report-left">
            <div class="report-date">${formatDateTime(r.ts)}</div>
            <div class="report-meta">${r.salesCount} vendas — ${r.itemsCount} itens</div>
          </div>
          <div class="report-right">
            <div class="report-value">${money(r.totalValue)}</div>
            <button class="small-btn view-report">Ver</button>
            <button class="small-btn download-report">Baixar PDF</button>
          </div>
        `;
          item.querySelector('.view-report').addEventListener('click', () => alert(buildReportQuickText(r)));
          item.querySelector('.download-report').addEventListener('click', () => downloadReportAsPDF(r));
          reportsListEl.appendChild(item);
        });
      }

      function buildReportQuickText(r) {
        const lines = [
          `Relatório: ${formatDateTime(r.ts)}`,
          `Vendas: ${r.salesCount} — Itens: ${r.itemsCount}`,
          `Total: ${money(r.totalValue)}`,
          '',
          'Detalhes:'
        ];
        r.items.forEach(it => lines.push(`${formatDateTime(it.ts)} — ${productLabel(it.product)} — ${it.qty} x ${money(it.unit)} = ${money(it.total)} — ${it.paymentMethod} — ${it.sellerName || it.seller || '--'}`));
        return lines.join('\n');
      }

      function updateMetaProgress() {
        const today = Date.now();
        const revenueToday = sales.filter(s => isSameDay(s.ts, today)).reduce((sum, s) => sum + s.total, 0);
        const percent = dailyGoal > 0 ? Math.min(100, Math.round((revenueToday / dailyGoal) * 100)) : 0;
        progressBar.style.width = percent + '%';
        metaPercent.textContent = percent + '%';
        metaNote.textContent = `R$ ${revenueToday.toFixed(2).replace('.', ',')} vendidos hoje.`;
      }

      // start
      init();
    })();
  </script>
</body>

</html>
